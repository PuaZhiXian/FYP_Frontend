<div class="min-h-screen bg-gray-100 pb-32">
  <div class="bg-primary-900">
    <admin-header></admin-header>
  </div>

  <div class="container md:mx-auto md:px-0 px-[20px]">
    <div class="my-4">
      <search-bar (filter)="searching($event)" placeholder="Search Collection"></search-bar>
    </div>
    <!--alphabet filter -->
    <div class="flex gap-2 mb-4">
      <button (click)="changeByAlphabet(alphabet)" *ngFor="let alphabet of alphabetArray"
              class="inline-flex cursor-pointer items-center justify-center text-white w-8 h-8 mr-2 transition-colors duration-150 rounded-full focus:shadow-outline border-0
              {{selectedAlphabet === alphabet ? 'bg-sky-400  hover:bg-sky-500' :'bg-gray-400  hover:bg-gray-500' }}">
        {{alphabet}}
      </button>
    </div>
    <div class="mb-4">
      <div class="flex gap-2 items-center justify-between">
        <!--Filter by category-->
        <div class="flex gap-2 items-center">
          <div class="text-docs-title">
            Filter By
          </div>
          <div class="grid grid-cols-6 gap-1">
            <div *ngFor="let category of apiCategoryList"
                 class="flex gap-1 w-full {{category.api_collections.length > 0 ? '': 'hidden'}}">
              <button (click)="removeFilter(category.id)"
                      *ngIf="filterCategory.indexOf(category.id) !== -1 && category.api_collections.length > 0"
                      class="w-full" nz-button
                      nzShape="round" nzType="primary">
                <div class="flex items-center justify-center gap-1">
                  <div class="text-sm material-icons-outlined">close</div>
                  <div class="text-sm">{{category.category_name}}</div>
                </div>
              </button>
              <button (click)="addFilter(category.id)"
                      *ngIf="filterCategory.indexOf(category.id) === -1 && category.api_collections.length > 0"
                      class="text-sm w-full"
                      nz-button nzShape="round">{{category.category_name}}</button>
            </div>
          </div>
        </div>
        <div>
          <button (click)="openCreateNewCategoryModal()" class="rounded" nz-button nzType="primary">
            <div class="flex items-center gap-1">
              <div class="text-sm">Create New Category</div>
            </div>
          </button>
        </div>
      </div>
    </div>
    <div *ngIf="!loading else loadingCollectionTpl">
      <div *ngFor="let category of filteredApiCategoryList; let j = index">
        <div *ngIf="category.api_collections.length > 0 "
             class="border-t border-b-0 border-solid border-x-0 pb-[24px] border-gray-600">
          <div class="flex items-center my-[14px] gap-4">
            <div>
              <nz-avatar class="border border-solid border-gray-900" nzIcon="user"
                         nzSrc="{{category.image_url || emptyIconUrl}}"></nz-avatar>
            </div>
            <div class="text-doc-title">{{category.category_name}}</div>
            <div class="grow flex justify-end">
              <span (click)="confirmDeleteCategory(category.id, category.category_name)"
                    [nzTooltipMouseEnterDelay]="0.75"
                    class="text-danger material-icons-outlined cursor-pointer text-title" nz-tooltip
                    nzTooltipPlacement="left"
                    nzTooltipTitle="Delete">delete_outline</span>
            </div>

          </div>
          <div class="grid grid-cols-3 gap-4">
            <nz-card (click)="openCreateNewCollectionModal(category.id)"
                     class="flex rounded-3xl items-center justify-center border-dotted border-2 border-[#59C3FF] cursor-pointer">
              <div class="flex items-center">
                <div class="material-icons-outlined text-[#59C3FF]">
                  add
                </div>
                <div class="text-[#59C3FF]">Add New Collection</div>
              </div>
            </nz-card>
            <div *ngFor="let apiCollection of category.api_collections ; let i = index "
                 class="rounded-3xl pl-4 {{ randomColorsArray[i % 10]}}">
              <nz-card class="rounded-r-[1.3rem] border-2">
                <div class="flex justify-between">
                  <div class="flex gap-x-4">
                    <div class="font-bold text-subtitle">{{apiCollection.api_collection_name}}</div>
                  </div>
                  <div class="justify-end">
                    <!--<button nz-tooltip
                            nzTooltipTitle="open" nzTooltipPlacement="left" [nzTooltipMouseEnterDelay]="0.75"
                            class="bg-blue-600 p-2 border-0 text-white rounded text-button material-icons-outlined cursor-pointer">
                      edit
                    </button>-->
                    <!--<span nz-tooltip
                          (click)="confirmDeleteCollection(apiCollection.id, apiCollection.api_collection_name)"
                          nzTooltipTitle="Delete" nzTooltipPlacement="left" [nzTooltipMouseEnterDelay]="0.75"
                          class="text-danger material-icons-outlined cursor-pointer text-[24px]">delete_outline</span>-->
                    <span [nzTooltipMouseEnterDelay]="0.75"
                          class="text-blue-600  material-icons-outlined cursor-pointer" nz-tooltip
                          nzTooltipPlacement="left"
                          nzTooltipTitle="Open In New Tab">open_in_new</span>
                  </div>
                </div>
                <div class="text-sm  min-h-[75px]">{{apiCollection.short_description}}</div>
                <nz-divider></nz-divider>
                <div class="flex justify-between">
                  <div>
                    <span>Created </span>
                    <span class="font-bold">{{apiCollection.createdAt | date: 'MMM d, y'}}</span>
                  </div>
                  <div class="justify-end">{{apiCollection.count}} Endpoints</div>
                </div>
              </nz-card>
            </div>
          </div>
        </div>
      </div>
      <div *ngIf="filteredApiCategoryList.length == 0">
        <nz-empty
          [nzNotFoundContent]="contentTpl"
          [nzNotFoundFooter]="footerTpl"
          nzNotFoundImage="https://gw.alipayobjects.com/zos/antfincdn/ZHrcdLPrvN/empty.svg">
          <ng-template #contentTpl>
            <span>Empty</span>
          </ng-template>
          <ng-template #footerTpl>
            <button (click)="openCreateNewCategoryModal()" nz-button nzType="primary">Create Now</button>
          </ng-template>
        </nz-empty>
      </div>
    </div>

  </div>
</div>

<ng-template #loadingTpl>
  <nz-skeleton></nz-skeleton>
</ng-template>

<!--Create Category Modal-->
<nz-modal (nzOnCancel)="closeCreateNewCategoryModal()" [(nzVisible)]="createNewCategoryModalVisibility">
  <div *nzModalTitle>
    <div>Create New Category</div>
  </div>
  <div *nzModalContent>
    <div>
      <form [formGroup]="createNewCategoryForm" nz-form>
        <!--Category Name-->
        <text-input [fieldRequired]="true" [submittedTry]="createCategorySubmittedTry"
                    errorMessage="Please input category Name!"
                    fieldTitle="Category Name" formControlName="category_name"
                    placeholder="category"></text-input>
        <!--Img Url-->
        <text-input [fieldRequired]="true" [submittedTry]="createCategorySubmittedTry"
                    errorMessage="Please input Image Url!"
                    fieldTitle="Img Url" formControlName="image_url"></text-input>
      </form>
    </div>
  </div>
  <div *nzModalFooter>
    <div>
      <button (click)="createNewApiCategory()"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Create
      </button>
      <button (click)="closeCreateNewCategoryModal()"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Cancel
      </button>
    </div>
  </div>
</nz-modal>

<!--Create Collection Modal - Upload File-->
<nz-modal (nzOnCancel)="closeCreateNewCollectionModal()" [(nzVisible)]="createNewCollectionModalVisibility">
  <div *nzModalTitle>
    <div>Create New Collection</div>
  </div>
  <div *nzModalContent>
    <nz-upload (nzChange)="handleChange($event)"
               [nzAccept]="'application/json'" [nzBeforeUpload]="beforeUpload" [nzDisabled]="currentFile.length > 0"
               nzAction="https://httpbin.org/post"
               nzType="drag">
      <p class="ant-upload-drag-icon">
        <span nz-icon nzType="inbox"></span>
      </p>
      <p class="ant-upload-text">Click or drag file to this area to upload</p>
      <p class="ant-upload-hint">
        Only support for a single upload. Strictly prohibit from uploading company data or other band files
      </p>
    </nz-upload>
  </div>
  <div *nzModalFooter>
    <div>
      <button (click)="createNewCollection()"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Create
      </button>
      <button (click)="closeCreateNewCollectionModal()"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Cancel
      </button>
    </div>
  </div>
</nz-modal>

<!--Preview create collection modal-->
<nz-modal (nzOnCancel)="closePreviewModal()" [(nzVisible)]="previewModalVisibility" [nzClassName]="'zero-padding-body'"
          [nzWidth]="1040">
  <div *nzModalTitle>
    <div>Preview New Collection</div>
  </div>
  <div *nzModalContent class="p-0">
    <div class="grid grid-cols-5">
      <div class="col-span-1  py-[24px] pl-[24px]">
        <nz-steps [nzCurrent]="pageNumber" nzDirection="vertical" nzSize="small">
          <nz-step nzTitle="Collection overview"></nz-step>
          <nz-step nzTitle="Collection object"></nz-step>
          <nz-step nzTitle="API Endpoint"></nz-step>
        </nz-steps>
      </div>
      <div class="col-span-4 bg-gray-300 p-[24px]">
        <div [ngSwitch]="pageNumber" class="h-min-[300px]">
          <div *ngSwitchCase="0">
            <ng-container *ngTemplateOutlet="collectionOverview"></ng-container>
          </div>
          <div *ngSwitchCase="1">
            <ng-container *ngTemplateOutlet="collectionObject"></ng-container>
          </div>
          <div *ngSwitchCase="2">
            <ng-container *ngTemplateOutlet="apiEndpoint"></ng-container>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div *nzModalFooter>
    <div *ngIf="pageNumber === 2">
      <button (click)="pageNumber = pageNumber - 1"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Back
      </button>
      <button (click)="confirmCreateCollection()"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Confirm
      </button>
    </div>
    <div *ngIf="pageNumber !== 2">
      <button (click)="pageNumber = pageNumber - 1" [disabled]="pageNumber === 0"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Back
      </button>
      <button (click)="pageNumber = pageNumber + 1"
              class="bg-primary-900 text-white px-[32px]rounded text-button font-bold min-w-[100px]" nz-button>Next
      </button>
    </div>
  </div>
</nz-modal>

<ng-template #loadingCollectionTpl>
  <div *ngFor="let index of [1,2,3]">
    <div class="border-t border-b-0 border-solid border-x-0 pb-[24px] border-gray-600">
      <div class="flex items-center my-[24px] gap-4">
        <nz-skeleton-element [nzActive]="true" nzType="button"></nz-skeleton-element>
      </div>
      <div class="grid grid-cols-3 gap-4">
        <div *ngFor="let j of [1,2,3]"
             class="rounded-3xl pl-4 {{ randomColorsArray[j % 10]}}">
          <nz-card class="rounded-r-[1.3rem] border-2">
            <nz-skeleton></nz-skeleton>
          </nz-card>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<!--API Collection Overview-->
<ng-template #collectionOverview>
  <nz-card class="rounded-lg">
    <div class="pb-[30px]">
      <div class="text-sm text-gray-500">Category</div>
      <div class="appearance-none px-0 w-full text-input text-gray-900 bg-transparent border-0">
        Category Name
      </div>
    </div>

    <div class="pb-[30px]">
      <div class="text-sm text-gray-500">API Collection Name</div>
      <div class="appearance-none px-0 w-full text-input text-gray-900 bg-transparent border-0">
        Lorem Ipsum
      </div>
    </div>

    <div class="pb-[30px]">
      <div class="text-sm text-gray-500">Short Description</div>
      <div class="appearance-none px-0 w-full text-input text-gray-900 bg-transparent border-0">
        Lorem Ipsum is simply dummy text of the printing and typesetting industry.
      </div>
    </div>

    <div class="pb-[30px]">
      <div class="text-sm text-gray-500">Long Description</div>
      <div class="appearance-none px-0 w-full text-input text-gray-900 bg-transparent border-0">
        There are many variations of passages of Lorem Ipsum available, but the majority have suffered alteration in
        some form, by injected humour, or randomised words which don't look even slightly believable. If you are going
        to use a passage of Lorem Ipsum, you need to be sure there isn't anything embarrassing hidden in the middle of
        text. All the Lorem Ipsum generators on the Internet tend to repeat predefined chunks as necessary, making this
        the first true generator on the Internet. It uses a dictionary of over 200 Latin words, combined with a handful
        of model sentence structures, to generate Lorem Ipsum which looks reasonable. The generated Lorem Ipsum is
        therefore always free from repetition, injected humour, or non-characteristic words etc.
      </div>
    </div>
  </nz-card>
</ng-template>

<!--API Object-->
<ng-template #collectionObject>
  <nz-card class="rounded-lg">
    <section>
      <!--Object attribute-->
      <div>
        <div class="text-doc-title font-medium">Object Attributes</div>
        <div class="mt-[20px]">
          <div class="text-label text-gray-800 font-medium pb-[12px]">Attributes</div>
          <div *ngFor="let attribute of apiCollectionObject.attr_ids"
               class="py-[16px] border-t border-gray-300">
            <!--name & variable type-->
            <div class="flex items-center">
              <div class="text-doc-text font-semibold text-gray-700 mr-[4px]">{{attribute.attr_name}}</div>
              <div class="text-xs font-semibold text-gray-400 mr-[4px]">{{attribute.attr_type}}</div>
            </div>
            <!--description-->
            <div class="text-doc-text text-justify ">{{attribute.attr_description}}</div>
            <div *ngIf="attribute.child_attr_ids" class="mt-[8px]">
              <child-attribute [childObject]="attribute.child_attr_ids" title="child attribute"></child-attribute>
            </div>
          </div>
        </div>
      </div>
      <!--Sample Json-->
      <div class="mt-[20px]">
        <div class="text-doc-title font-medium">Sample Json</div>
        <div class="mb-[12px] sticky top-0">
          <!--Header-->
          <div class="px-[12px] py-[10px] text-gray-500 text-xs
              font-medium bg-gray-100 border rounded-t">The object
          </div>
          <!--Content-->
          <div class="flex flex-col gap-[9px] border rounded-b bg-gray-50 max-h-[400px]">
          <pre class="light mb-0"><code
            class="language-json h-[210px] text-xs">{{apiCollectionObject.object}}</code></pre>
          </div>
        </div>
      </div>
    </section>
  </nz-card>
</ng-template>

<!--API Endpoints-->
<ng-template #apiEndpoint>
  <nz-card class="rounded-lg">
    <nz-collapse [nzBordered]="false">
      <div *ngFor="let endpoint of api_ids ; let j = index">
        <nz-collapse-panel [nzHeader]="apiCollectionHeader" [nzShowArrow]="false">
          <!--Collapse body-->
          <div>
            <div>
              <!--Endpoint description-->
              <div class="text-doc-text text-justify">{{endpoint.api_description}}</div>
              <!--parameter attribute-->
              <div class="mt-[20px]">
                <div class="text-label text-gray-800 font-medium pb-[12px]">Parameters</div>
                <div *ngFor="let attribute of endpoint.api_param_ids" class="py-[16px] border-t border-gray-300">
                  <!--name & variable type-->
                  <div class="flex items-center">
                    <div class="text-doc-text font-semibold text-gray-700 mr-[4px]">{{attribute.attr_name}}</div>
                    <div class="text-xs font-semibold text-gray-400 mr-[4px]">{{attribute.attr_type}}</div>
                  </div>
                  <!--description-->
                  <div class="text-doc-text text-justify ">{{attribute.attr_description}}</div>
                  <!--<div class="mt-[8px]" *ngIf="attribute.child_attr_ids">
                    <child-attribute title="child attribute" [childObject]="attribute.child_attr_ids"></child-attribute>
                  </div>-->
                </div>
                <div *ngIf="endpoint.api_param_ids?.length == 0"
                     class="py-[16px] text-xs text-gray-400 font-normal border-t border-gray-300">
                  No parameters
                </div>
              </div>
              <!--Return-->
              <div class="mt-[20px]">
                <div class="text-label text-gray-800 font-medium pb-[12px]">Return</div>
                <div class="text-doc-text text-justify py-[16px] border-t border-gray-300">{{endpoint.api_return}}</div>
              </div>
              <!--Request Code-->
              <div class="mt-[12px]">
                <div (click)="init()" class="text-label text-gray-800 font-medium pb-[12px]">Sample Code</div>
                <code-editor (programmingLanguageChange)="switchLanguage($event)" *ngIf="!switchingLang"
                             [code]="endpoint.api_req_code" [programmingLanguageOptions]="programmingLanguageOptions"
                             [programmingLanguage]="programmingLanguage"
                             [title]="endpoint.api_method + ' ' + endpoint.api_endpoint "
                             class="mb-[12px]"></code-editor>
              </div>
              <!--Response Json-->
              <div class="mt-[12px]">
                <!--Header-->
                <div
                  class="px-[12px] py-[10px] text-gray-500 text-xs font-medium bg-gray-100 border rounded-t cursor-pointer">
                  Response
                </div>
                <!--Content-->
                <highlightjs [code]="endpoint.api_response_json" extraClass=" "></highlightjs>
              </div>
            </div>
          </div>

          <ng-template #apiCollectionHeader>
            <div (click)="init()" class="flex items-center">
              <div class="m-2 p-2 bg-rose-200 font-bold text-[10px] w-[80px] h-full text-center rounded-lg">
                {{endpoint.api_method}}
              </div>
              <div class="m-2">
                <div class="font-bold">{{endpoint.api_name}}</div>
                <div class="text-sm text-gray-400">{{endpoint.api_endpoint}}</div>
              </div>
            </div>
          </ng-template>
        </nz-collapse-panel>
      </div>
    </nz-collapse>
  </nz-card>
</ng-template>
